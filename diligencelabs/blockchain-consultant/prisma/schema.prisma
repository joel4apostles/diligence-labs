// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model User {
  id            String    @id @default(cuid())
  email         String    @unique
  emailVerified DateTime?
  name          String?
  image         String?
  role          Role      @default(USER)
  
  // Social login IDs
  googleId      String?   @unique
  githubId      String?   @unique
  twitterId     String?   @unique
  
  // Blockchain wallet
  walletAddress String?   @unique
  
  // Authentication
  password      String?
  
  // Password reset
  passwordResetToken String?
  passwordResetExpiry DateTime?
  failedLoginAttempts Int @default(0)
  lastFailedLogin DateTime?
  accountLockedUntil DateTime?
  
  // Account management
  accountStatus AccountStatus @default(ACTIVE)
  accountStatusReason String?
  statusChangedAt DateTime?
  statusChangedBy String?
  
  // Email verification
  emailVerificationToken String?
  emailVerificationExpiry DateTime?
  
  // Free consultation tracking
  freeConsultationUsed Boolean   @default(false)
  freeConsultationDate DateTime?
  
  // Subscription tracking
  stripeCustomerId String?
  
  // Timestamps
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  // Relations
  sessions      Session[]
  reports       Report[]
  accounts      Account[]
  teamMember    TeamMember?
  assignedReports  ReportAssignment[]
  assignedSessions SessionAssignment[]
  createdAssignments ReportAssignment[] @relation("AssignedBy")
  subscriptions Subscription[]
  notificationLogs AdminNotificationLog[]
  activityLogs UserActivityLog[]
  
  // Performance indexes
  @@index([email])
  @@index([role])
  @@index([accountStatus])
  @@index([failedLoginAttempts])
  @@index([createdAt])
  @@index([role, accountStatus])
  @@index([failedLoginAttempts, lastFailedLogin])
  
  @@map("users")
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@index([userId])
  @@index([type])
  @@map("accounts")
}

model Session {
  id               String           @id @default(cuid())
  userId           String?
  consultationType ConsultationType
  status           SessionStatus    @default(PENDING)
  description      String?
  scheduledAt      DateTime?
  completedAt      DateTime?
  notes            String?
  priority         Priority         @default(MEDIUM)
  estimatedHours   Int?
  
  // Guest session data (for non-authenticated users)
  guestEmail       String?
  guestName        String?
  guestPhone       String?
  
  // Account creation invitation
  accountCreationToken String?
  accountCreationExpiry DateTime?
  
  // Free consultation tracking
  isFreeConsultation Boolean         @default(false)
  clientIpAddress    String?
  clientFingerprint  String?
  
  // Timestamps
  createdAt        DateTime         @default(now())
  updatedAt        DateTime         @updatedAt
  
  // Relations
  user             User?            @relation(fields: [userId], references: [id], onDelete: Cascade)
  assignments      SessionAssignment[]
  
  // Performance indexes
  @@index([userId])
  @@index([status])
  @@index([consultationType])
  @@index([scheduledAt])
  @@index([createdAt])
  @@index([isFreeConsultation])
  @@index([status, userId])
  @@index([status, createdAt])
  @@index([guestEmail])
  
  @@map("sessions")
}

model Report {
  id          String       @id @default(cuid())
  userId      String
  title       String
  description String?
  fileUrl     String?
  status      ReportStatus @default(PENDING)
  type        ReportType
  priority    Priority     @default(MEDIUM)
  complexity  Complexity   @default(MEDIUM)
  estimatedHours Int?
  actualHours    Int?
  deadline    DateTime?
  
  // Timestamps
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
  
  // Relations
  user        User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  assignments ReportAssignment[]
  
  // Performance indexes
  @@index([userId])
  @@index([status])
  @@index([type])
  @@index([priority])
  @@index([createdAt])
  @@index([deadline])
  @@index([status, userId])
  @@index([status, createdAt])
  @@index([type, status])
  
  @@map("reports")
}

model TeamMember {
  id             String           @id @default(cuid())
  userId         String           @unique
  position       String
  department     Department
  hourlyRate     Float?
  isActive       Boolean          @default(true)
  maxHoursPerWeek Int             @default(40)
  currentWorkload Int             @default(0)
  
  // Timestamps
  createdAt      DateTime         @default(now())
  updatedAt      DateTime         @updatedAt
  
  // Relations
  user           User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  specializations TeamMemberSpecialization[]
  
  // Performance indexes
  @@index([userId])
  @@index([department])
  @@index([isActive])
  @@index([isActive, department])
  
  @@map("team_members")
}

model TeamMemberSpecialization {
  id             String         @id @default(cuid())
  teamMemberId   String
  specialization Specialization
  
  // Timestamps
  createdAt      DateTime       @default(now())
  
  // Relations
  teamMember     TeamMember     @relation(fields: [teamMemberId], references: [id], onDelete: Cascade)
  
  @@unique([teamMemberId, specialization])
  @@index([teamMemberId])
  @@index([specialization])
  
  @@map("team_member_specializations")
}

model ReportAssignment {
  id           String              @id @default(cuid())
  reportId     String
  assigneeId   String
  assignedById String
  role         AssignmentRole      @default(CONTRIBUTOR)
  status       AssignmentStatus    @default(ASSIGNED)
  estimatedHours Int?
  actualHours    Int?
  notes        String?
  
  // Timestamps
  createdAt    DateTime            @default(now())
  updatedAt    DateTime            @updatedAt
  startedAt    DateTime?
  completedAt  DateTime?
  
  // Relations
  report       Report              @relation(fields: [reportId], references: [id], onDelete: Cascade)
  assignee     User                @relation(fields: [assigneeId], references: [id], onDelete: Cascade)
  assignedBy   User                @relation("AssignedBy", fields: [assignedById], references: [id])
  
  @@unique([reportId, assigneeId])
  @@index([reportId])
  @@index([assigneeId])
  @@index([assignedById])
  @@index([status])
  @@index([createdAt])
  @@index([status, assigneeId])
  
  @@map("report_assignments")
}

model SessionAssignment {
  id           String              @id @default(cuid())
  sessionId    String
  assigneeId   String
  role         AssignmentRole      @default(LEAD)
  status       AssignmentStatus    @default(ASSIGNED)
  estimatedHours Int?
  actualHours    Int?
  notes        String?
  
  // Timestamps
  createdAt    DateTime            @default(now())
  updatedAt    DateTime            @updatedAt
  startedAt    DateTime?
  completedAt  DateTime?
  
  // Relations
  session      Session             @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  assignee     User                @relation(fields: [assigneeId], references: [id], onDelete: Cascade)
  
  @@unique([sessionId, assigneeId])
  @@index([sessionId])
  @@index([assigneeId])
  @@index([status])
  @@index([createdAt])
  @@index([status, assigneeId])
  
  @@map("session_assignments")
}

enum Role {
  USER
  ADMIN
  TEAM_MEMBER
}

enum ConsultationType {
  STRATEGIC_ADVISORY
  DUE_DILIGENCE
  TOKENOMICS_DESIGN
  TOKEN_LAUNCH
}

enum SessionStatus {
  PENDING
  SCHEDULED
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

enum ReportStatus {
  PENDING
  IN_REVIEW
  COMPLETED
  REJECTED
}

enum ReportType {
  DUE_DILIGENCE
  ADVISORY_NOTES
  BLOCKCHAIN_INTEGRATION_ADVISORY
  MARKET_RESEARCH
}

enum Department {
  BLOCKCHAIN_INTEGRATION
  STRATEGY_CONSULTING
  DUE_DILIGENCE
  TOKEN_ECONOMICS
  MARKETING
  BUSINESS_DEVELOPMENT
  PROJECT_MANAGEMENT
  RESEARCH
}

enum Specialization {
  SMART_CONTRACTS
  DEFI_PROTOCOLS
  TOKENOMICS
  MARKET_ANALYSIS
  REGULATORY_COMPLIANCE
  SECURITY_AUDITING
  BLOCKCHAIN_ARCHITECTURE
  INVESTMENT_ANALYSIS
  CRYPTO_TRADING
  NFT_MARKETS
  DAO_GOVERNANCE
  LAYER2_SOLUTIONS
  BLOCKCHAIN_SELECTION
  INFRASTRUCTURE_PARTNERS
  WHITE_LABEL_SOLUTIONS
  DEVELOPMENT_FRAMEWORKS
}

enum Priority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

enum Complexity {
  SIMPLE
  MEDIUM
  COMPLEX
  VERY_COMPLEX
}

enum AssignmentRole {
  LEAD
  CONTRIBUTOR
  REVIEWER
  ADVISOR
}

enum AssignmentStatus {
  ASSIGNED
  IN_PROGRESS
  COMPLETED
  ON_HOLD
  CANCELLED
}

model Subscription {
  id                String              @id @default(cuid())
  userId            String
  stripeSubscriptionId String           @unique
  status            SubscriptionStatus  @default(ACTIVE)
  planType          SubscriptionPlan
  planId            String?             // For API references like 'basic', 'professional', etc.
  billingCycle      BillingCycle       @default(MONTHLY)
  currentPeriodStart DateTime
  currentPeriodEnd   DateTime
  cancelAtPeriodEnd  Boolean            @default(false)
  canceledAt        DateTime?
  trialEnd          DateTime?
  
  // Pricing
  amount            Float              // Amount in dollars
  currency          String             @default("usd")
  
  // Timestamps
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt
  
  // Relations
  user              User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Performance indexes
  @@index([userId])
  @@index([status])
  @@index([planType])
  @@index([currentPeriodEnd])
  @@index([status, userId])
  @@index([status, currentPeriodEnd])
  
  @@map("subscriptions")
}

enum SubscriptionStatus {
  ACTIVE
  PAUSED
  CANCELED
  PAST_DUE
  INCOMPLETE
  TRIALING
}

enum SubscriptionPlan {
  BASIC_MONTHLY
  PROFESSIONAL_MONTHLY
  ENTERPRISE_MONTHLY
}

enum BillingCycle {
  MONTHLY
  YEARLY
}

model AdminUser {
  id               String    @id @default(cuid())
  email            String    @unique
  name             String
  hashedPassword   String
  role             AdminRole @default(ADMIN)
  isActive         Boolean   @default(true)
  lastLogin        DateTime?
  
  // Timestamps
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt
  
  // Relations
  notificationLogs AdminNotificationLog[]
  
  // Performance indexes
  @@index([email])
  @@index([role])
  @@index([isActive])
  @@index([role, isActive])
  
  @@map("admin_users")
}

enum AdminRole {
  SUPER_ADMIN
  ADMIN
  MODERATOR
}

enum AccountStatus {
  ACTIVE
  SUSPENDED
  RESTRICTED
  DISABLED
  PENDING_VERIFICATION
}

model AdminNotificationLog {
  id               String    @id @default(cuid())
  userId           String
  adminId          String
  notificationType String    // 'subscription_status', 'malicious_activity', 'subscription_expiration'
  emailSent        Boolean   @default(false)
  details          String? // JSON string with notification details
  
  // Timestamps
  createdAt        DateTime  @default(now())
  
  // Relations
  user             User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  admin            AdminUser @relation(fields: [adminId], references: [id])
  
  // Performance indexes
  @@index([userId])
  @@index([adminId])
  @@index([notificationType])
  @@index([emailSent])
  @@index([createdAt])
  @@index([emailSent, createdAt])
  @@index([notificationType, emailSent])
  
  @@map("admin_notification_logs")
}

model UserActivityLog {
  id          String   @id @default(cuid())
  userId      String
  action      String   // 'LOGIN', 'LOGOUT', 'FAILED_LOGIN', 'PASSWORD_RESET', 'SECURITY_NOTIFICATION_SENT', etc.
  details     String?
  ipAddress   String?
  userAgent   String?
  
  // Timestamps
  createdAt   DateTime @default(now())
  
  // Relations
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Performance indexes
  @@index([userId])
  @@index([action])
  @@index([createdAt])
  @@index([userId, action])
  @@index([userId, createdAt])
  @@index([action, createdAt])
  
  @@map("user_activity_logs")
}

model AdminKey {
  id          String    @id @default(cuid())
  key         String    @unique
  description String?
  createdBy   String
  isActive    Boolean   @default(true)
  usageCount  Int       @default(0)
  maxUsages   Int?
  expiresAt   DateTime?
  
  // Timestamps
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  
  // Performance indexes
  @@index([key])
  @@index([isActive])
  @@index([createdBy])
  @@index([expiresAt])
  @@index([isActive, expiresAt])
  
  @@map("admin_keys")
}
